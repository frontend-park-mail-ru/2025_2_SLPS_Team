<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>molecules/RegForm/RegForm.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="RegistrationForm.html">RegistrationForm</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-FormInput.html">FormInput</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-LoginForm.html">LoginForm</a></span></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-FormInput.html">FormInput</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-LoginForm.html">LoginForm</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#renderFeed">renderFeed</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#renderFormButton">renderFormButton</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#renderIconButton">renderIconButton</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#renderMenu">renderMenu</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#renderMenuItem">renderMenuItem</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#renderNavButton">renderNavButton</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#renderPost">renderPost</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">molecules/RegForm/RegForm.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import FormInput from "../../atoms/FormInput/FromInput.js";
import { renderFormButton } from "../../atoms/FormButtons/FormButton.js";
import CONFIG from '/config.js'

/**
 * Класс для рендеринга многошаговой формы регистрации.
 *
 * @class RegistrationForm
 * @property {HTMLElement} container - DOM-элемент, в который рендерится форма.
 * @property {Object} options - Опции и коллбеки формы.
 * @property {Function} [options.onSubmit] - Коллбек, вызываемый при успешной регистрации.
 * @property {Function} [options.onLog] - Коллбек, вызываемый при переходе к авторизации.
 * @property {Function} [options.onStepChange] - Коллбек, вызываемый при смене шага регистрации.
 * @property {HTMLFormElement|null} form - Ссылка на DOM-элемент формы.
 * @property {Object.&lt;string, FormInput>} inputs - Поля ввода, сгруппированные по имени.
 * @property {number} currentStep - Текущий шаг регистрации (1, 2 или 3).
 * @property {Object} savedValues - Сохранённые значения с предыдущих шагов.
 * @property {boolean} emailError - Флаг ошибки email (например, если email занят).
 */
export default class RegistrationForm {
    constructor(container, options = {}) {
        this.container = container;
        this.options = options;
        this.form = null;
        this.inputs = {};
        this.currentStep = 1;
        this.savedValues = {};
        this.emailError = false;
    }

    async render() {
        const template = Handlebars.templates['RegFrom.hbs'];
        const html = template();

        const wrapper = document.createElement("div");
        wrapper.innerHTML = html.trim();

        this.form = wrapper.querySelector("form");
        this.container.appendChild(this.form);

        this.inputContainer = this.form.querySelector(".input-container");
        this.buttons = this.form.querySelector(".button-container");

        this.renderStep();
    }

    renderStep() {
        this.inputContainer.innerHTML = "";
        this.buttons.innerHTML = "";

        if (this.options.onStepChange) {
            this.options.onStepChange(this.currentStep);
        }

        if (this.currentStep === 1) {
            this.renderStep1();
        } else if (this.currentStep === 2) {
            this.renderStep2();
        } else if (this.currentStep === 3) {
            this.renderStep3();
        }
    }

    async renderStep1() {
        this.inputs.email = new FormInput(this.inputContainer, {
            name: "email",
            label: "Email",
            type: "email",
            placeholder: "Введите email",
            required: true,
            showRequired: true,
            value: this.savedValues?.email || ""
        });
        await this.inputs.email.render();

        this.inputs.password = new FormInput(this.inputContainer, {
            name: "password",
            label: "Пароль",
            type: "password",
            placeholder: "Введите пароль",
            required: true,
            showRequired: true,
            value: this.savedValues?.password || ""
        });
        await this.inputs.password.render();

        this.inputs.confirmPassword = new FormInput(this.inputContainer, {
            name: "confirmPassword",
            label: "Повторите пароль",
            type: "password",
            placeholder: "Повторите пароль",
            required: true,
            showRequired: true,
            value: this.savedValues?.confirmPassword || ""
        });
        await this.inputs.confirmPassword.render();

        if(this.emailError){
            this.validateStep1();
        }

        await renderFormButton(this.buttons, "button", "Далее", "accent", (e) => {
            e.preventDefault();
            if (this.validateStep1()) {
                this.savedValues.email = this.inputs.email.input.value;
                this.savedValues.password = this.inputs.password.input.value;
                this.savedValues.confirmPassword = this.inputs.confirmPassword.input.value;

                this.currentStep = 2;
                this.renderStep();
            }
        });

        renderFormButton(this.buttons, "button", "Войти", "base", (e) => {
            e.preventDefault();
            this.handleLogin();
        });
    }

    async renderStep2() {
        this.inputs.firstName = new FormInput(this.inputContainer, {
            name: "firstName",
            label: "Имя",
            type: "text",
            placeholder: "Введите имя",
            required: true,
            value: this.savedValues?.firstName || null
        });
        await this.inputs.firstName.render();

        this.inputs.lastName = new FormInput(this.inputContainer, {
            name: "lastName",
            label: "Фамилия",
            type: "text",
            placeholder: "Введите фамилию",
            required: true,
            value: this.savedValues?.lastName || null
        });
        await this.inputs.lastName.render();

        await renderFormButton(this.buttons, "button", "Далее", "accent", (e) => {
            e.preventDefault();
            if (this.validateStep2()) {
                this.savedValues.firstName = this.inputs.firstName.input.value;
                this.savedValues.lastName = this.inputs.lastName.input.value;
                this.currentStep = 3;
                this.renderStep();
            }
        });

        await renderFormButton(this.buttons, "button", "Назад", "base", (e) => {
            e.preventDefault();
            this.currentStep = 1;
            this.renderStep();
        });
    }

    async renderStep3() {
        this.inputs.age = new FormInput(this.inputContainer, {
            name: "age",
            label: "Возраст",
            type: "text",
            placeholder: "Введите возраст",
            required: true,
        });
        await this.inputs.age.render();

        const genderLabel = document.createElement("div");
        genderLabel.textContent = "Выберите пол";
        genderLabel.classList.add("small-lable")

        const genderContainer = document.createElement("div");
        genderContainer.classList.add("gender-container");

        genderContainer.innerHTML = `
            &lt;label class="remember-me">
                &lt;input type="checkbox" name="gender" value="male">
                &lt;span class="custom-checkbox">&lt;/span>
                &lt;div>Мужчина&lt;/div>
            &lt;/label>
            &lt;label class="remember-me">
                &lt;input type="checkbox" name="gender" value="female">
                &lt;span class="custom-checkbox">&lt;/span>
                &lt;div>Женщина&lt;/div>
            &lt;/label>
        `;

        this.inputContainer.appendChild(genderLabel);
        this.inputContainer.appendChild(genderContainer);

        const checkboxes = genderContainer.querySelectorAll('input[name="gender"]');
        checkboxes.forEach((checkbox) => {
            checkbox.addEventListener("change", () => {
                if (checkbox.checked) {
                    checkboxes.forEach((cb) => {
                        if (cb !== checkbox) cb.checked = false;
                    });
                }
            });
        });


        await renderFormButton(this.buttons, "submit", "Завершить", "accent", (e) => {
            e.preventDefault();
            if (this.validateStep3()) {
                this.handleSubmit();
            }
        });

        await renderFormButton(this.buttons, "button", "Назад", "base", (e) => {
            e.preventDefault();
            this.currentStep = 2;
            this.renderStep();
        });
    }

    validateStep1() {
        let valid = true;
        const email = this.inputs.email.input.value.trim();
        const pass = this.inputs.password.input.value.trim();
        const confirm = this.inputs.confirmPassword.input.value.trim();

        this.inputs.email.hideError();
        this.inputs.password.hideError();
        this.inputs.confirmPassword.hideError();
        if(this.emailError){
            this.inputs.email.showError("email занят");
            valid = false;
            this.emailError = false;
        }
        if (!email.includes("@")) {
            this.inputs.email.showError("Введите корректный email");
            valid = false;
        }
        if (pass.length &lt; 6) {
            this.inputs.password.showError("Пароль слишком короткий");
            valid = false;
        }
        if (pass !== confirm) {
            this.inputs.confirmPassword.showError("Пароли не совпадают");
            valid = false;
        }

        return valid;
    }

    validateStep2() {
        let valid = true;
        const firstName = this.inputs.firstName.input.value.trim();
        const lastName = this.inputs.lastName.input.value.trim();

        this.inputs.firstName.hideError();
        this.inputs.lastName.hideError();

        if (!firstName) {
            this.inputs.firstName.showError("Введите имя");
            valid = false;
        }
        if (!lastName) {
            this.inputs.lastName.showError("Введите фамилию");
            valid = false;
        }

        return valid;
    }

    validateStep3() {
        let valid = true;
        const age = parseInt(this.inputs.age.input.value.trim(), 10);

        this.inputs.age.hideError();

        if (isNaN(age) || age &lt;= 0) {
            this.inputs.age.showError("Введите корректный возраст");
            valid = false;
        }

        return valid;
    }

    handleSubmit() {
        const data = {
            email: this.inputs.email.input.value.trim(),
            password: this.inputs.password.input.value.trim(),
            firstName: this.inputs.firstName.input.value.trim(),
            lastName: this.inputs.lastName.input.value.trim(),
            age: this.inputs.age.input.value.trim(),
            gender: this.form.querySelector('input[name="gender"]:checked')?.value || null,
        };
        try {
            const res = fetch(`${CONFIG.API_BASE_URL}/api/auth/register`, {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    Username: data.username,
                    Email: data.email,
                    Password: data.password,
                    ConfirmPassword: data.confirm_password,
                }),
            });

                const result = res.json();

                if (result.Message === "User already exist") {
                    this.emailError = true;
                    this.currentStep = 1;
                    this.renderStep(true);
                    return;
                }
            

            console.log("Регистрация завершена:", data);

            if (this.options.onSubmit) {
                this.options.onSubmit(data);
            }
        }catch (err) {
            console.error('Ошибка при регистрации:', err);
        }
    }


    handleLogin() {
        if (this.options.onLog) {
            this.options.onLog();
        }
    }
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> on Mon Sep 29 2025 10:23:55 GMT+0300 (Moscow Standard Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
